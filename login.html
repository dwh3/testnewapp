<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>FitTrack - Welcome</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />

  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-500: #64748b;
      --white: #ffffff;
      --safe-area-top: env(safe-area-inset-top);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; display:flex; align-items:center; justify-content:center;
      padding: 20px; padding-top: var(--safe-area-top);
    }
    .login-container {
      width: 100%; max-width: 400px; background: var(--white);
      border-radius: 24px; padding: 40px 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px);} to {opacity: 1; transform: translateY(0);} }
    .logo-section { text-align:center; margin-bottom: 30px; }
    .logo {
      width: 80px; height:80px; background: var(--primary); border-radius: 20px; margin: 0 auto 16px;
      display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size: 28px;
      animation: pulse 2s ease infinite;
    }
    @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }
    .app-title { font-size: 24px; font-weight: 800; color:#1e293b; margin-bottom:6px; }
    .app-subtitle { color: var(--gray-500); font-size: 14px; }

    .message { display:none; padding:12px; border-radius:8px; font-size:14px; text-align:center; margin-bottom:14px; }
    .message.error { background:#fef2f2; border:1px solid #fecaca; color:#dc2626; }
    .message.success { background:#f0fdf4; border:1px solid #bbf7d0; color:#16a34a; }

    .hidden { display:none !important; }
    .profile-selection { display:none; }
    .profile-list { max-height: 220px; overflow-y:auto; margin-bottom: 12px; }
    .profile-item {
      display:flex; align-items:center; padding:14px; border:2px solid var(--gray-200);
      border-radius:16px; margin-bottom:10px; cursor:pointer; transition: all .2s;
      background: #fff;
    }
    .profile-item:hover { border-color: var(--primary); transform: translateX(4px); background:#f8f9ff; }
    .profile-avatar {
      width:48px; height:48px; border-radius:50%; background:var(--primary);
      color:white; display:flex; align-items:center; justify-content:center; font-weight:700; margin-right:12px;
    }
    .profile-name { font-weight:700; color:#1e293b; }
    .profile-stats { font-size:12px; color:var(--gray-500); }
    .form-group { margin-bottom: 14px; }
    .form-label { display:block; font-weight:600; color:#334155; margin-bottom:8px; }
    .form-input {
      width:100%; padding:12px 14px; border:1px solid #e2e8f0; border-radius:12px; font-size:16px;
    }
    .pin-input-group { display:flex; gap:8px; justify-content:center; margin-bottom: 12px; }
    .pin-input { width:50px; height:56px; text-align:center; font-size:24px; font-weight:700; border:2px solid var(--gray-200); border-radius:12px; }
    .btn-primary { width:100%; padding:14px; border:none; border-radius:12px; background:var(--primary); color:white; font-weight:700; }
    .btn-secondary { width:100%; padding:14px; border:2px solid var(--gray-200); border-radius:12px; background:white; font-weight:700; color:#334155; margin-top:8px; }
    .text-link { color: var(--primary); cursor: pointer; }
    .mt-3 { margin-top: 14px; }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo-section">
      <div class="logo">FIT</div>
      <div class="app-title">Welcome to FitTrack</div>
      <div class="app-subtitle">Your personal fitness journey</div>
    </div>

    <div id="message" class="message"></div>

    <!-- Profile selection -->
    <div id="profileSelection" class="profile-selection">
      <div class="profile-list" id="profileList"></div>
      <button class="btn-secondary" onclick="showNewProfile()">
        <i class="bi bi-person-plus"></i> Create New Profile
      </button>
    </div>

    <!-- New profile -->
    <div id="newProfile" class="">
      <form id="createProfileForm">
        <div class="form-group">
          <label class="form-label">Your Name</label>
          <input type="text" class="form-input" id="userName" required maxlength="30" placeholder="Enter your name" />
        </div>
        <div class="form-group">
          <label class="form-label">Create a 4‑digit PIN</label>
          <div class="pin-input-group">
            <input type="password" inputmode="numeric" class="pin-input" id="pin1" maxlength="1" required />
            <input type="password" inputmode="numeric" class="pin-input" id="pin2" maxlength="1" required />
            <input type="password" inputmode="numeric" class="pin-input" id="pin3" maxlength="1" required />
            <input type="password" inputmode="numeric" class="pin-input" id="pin4" maxlength="1" required />
          </div>
        </div>
        <button type="submit" class="btn-primary">Create Profile</button>
      </form>
    </div>

    <!-- PIN entry -->
    <div id="pinEntry" class="hidden">
      <h5 class="text-center" style="margin-bottom:12px;">Welcome back, <span id="selectedUserName"></span>!</h5>
      <form id="verifyPinForm">
        <div class="pin-input-group">
          <input type="password" inputmode="numeric" class="pin-input" id="verify1" maxlength="1" required />
          <input type="password" inputmode="numeric" class="pin-input" id="verify2" maxlength="1" required />
          <input type="password" inputmode="numeric" class="pin-input" id="verify3" maxlength="1" required />
          <input type="password" inputmode="numeric" class="pin-input" id="verify4" maxlength="1" required />
        </div>
        <button type="submit" class="btn-primary">Sign In</button>
        <button type="button" class="btn-secondary" onclick="showExistingProfiles()">Switch Profile</button>
      </form>
      <p class="text-center mt-3"><span class="text-link" onclick="forgotPin()">Forgot PIN?</span></p>
    </div>
  </div>

  <script>
    let selectedProfile = null;

    // ===== CRYPTO UTILITIES FOR PIN HASHING =====
    /**
     * Hash a PIN using PBKDF2 with Web Crypto API
     * Security: 100k iterations, SHA-256, 16-byte salt
     */
    async function hashPin(pin, salt = null) {
      if (!salt) {
        salt = crypto.getRandomValues(new Uint8Array(16));
      }

      const encoder = new TextEncoder();
      const pinBuffer = encoder.encode(pin);

      const keyMaterial = await crypto.subtle.importKey(
        'raw', pinBuffer, 'PBKDF2', false, ['deriveBits']
      );

      const hashBuffer = await crypto.subtle.deriveBits(
        {
          name: 'PBKDF2',
          salt: salt,
          iterations: 100000, // OWASP recommended
          hash: 'SHA-256'
        },
        keyMaterial,
        256
      );

      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      const saltHex = Array.from(salt).map(b => b.toString(16).padStart(2, '0')).join('');

      return { hash: hashHex, salt: saltHex };
    }

    /**
     * Verify a PIN against stored hash
     */
    async function verifyPinHash(pin, storedHash, storedSalt) {
      try {
        const saltArray = new Uint8Array(
          storedSalt.match(/.{2}/g).map(byte => parseInt(byte, 16))
        );
        const { hash } = await hashPin(pin, saltArray);
        return hash === storedHash;
      } catch (err) {
        console.error('PIN verification error:', err);
        return false;
      }
    }

    /**
     * Migrate existing profiles from plaintext PINs to hashed PINs
     */
    async function migrateProfilePins() {
      const profiles = getProfiles();
      let migrated = false;

      for (const profile of profiles) {
        // Check if profile has old plaintext PIN (no pinHash field)
        if (profile.pin && !profile.pinHash) {
          try {
            const { hash, salt } = await hashPin(profile.pin);
            profile.pinHash = hash;
            profile.pinSalt = salt;
            delete profile.pin; // Remove plaintext
            migrated = true;
          } catch (err) {
            console.error('Migration failed for profile:', profile.name, err);
          }
        }
      }

      if (migrated) {
        saveProfiles(profiles);
        console.log('PIN migration completed for', profiles.length, 'profile(s)');
      }
    }

    // ===== END CRYPTO UTILITIES =====

    document.addEventListener('DOMContentLoaded', async () => {
      setupPinInputs();

      // Migrate existing profiles on load
      await migrateProfilePins();

      checkExistingProfiles();

      document.getElementById('createProfileForm').addEventListener('submit', createProfile);
      document.getElementById('verifyPinForm').addEventListener('submit', verifyPin);
    });

    function getProfiles() {
      const profilesData = localStorage.getItem('fittrack_profiles');
      return profilesData ? JSON.parse(profilesData) : [];
    }
    function saveProfiles(profiles) {
      localStorage.setItem('fittrack_profiles', JSON.stringify(profiles));
    }
    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = 'message ' + type;
      messageDiv.style.display = 'block';
    }
    function hideMessage() {
      const messageDiv = document.getElementById('message');
      messageDiv.style.display = 'none';
    }

    function checkExistingProfiles() {
      const profiles = getProfiles();
      if (profiles.length === 0) {
        document.getElementById('newProfile').classList.remove('hidden');
        document.getElementById('profileSelection').style.display = 'none';
      } else {
        showExistingProfiles();
      }
    }

    function showExistingProfiles() {
      hideAllSections();
      const profiles = getProfiles();
      const profileList = document.getElementById('profileList');
      profileList.innerHTML = profiles.map(profile => {
        const initials = profile.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const workouts = profile.data?.setsLog?.length || 0;
        return `
          <div class="profile-item" onclick="selectProfile('${profile.id}')">
            <div class="profile-avatar">${initials}</div>
            <div style="flex:1">
              <div class="profile-name">${profile.name}</div>
              <div class="profile-stats">${workouts} sets logged</div>
            </div>
            <i class="bi bi-chevron-right" style="color:#64748b;font-size:20px;"></i>
          </div>`;
      }).join('');
      document.getElementById('profileSelection').style.display = 'block';
    }

    function hideAllSections() {
      document.getElementById('profileSelection').style.display = 'none';
      document.getElementById('newProfile').classList.add('hidden');
      document.getElementById('pinEntry').classList.add('hidden');
      hideMessage();
    }

    function showNewProfile() {
      hideAllSections();
      document.getElementById('newProfile').classList.remove('hidden');
      document.getElementById('userName').focus();
    }

    async function createProfile(e) {
      e.preventDefault();
      const name = document.getElementById('userName').value.trim();
      const pin = (document.getElementById('pin1').value || '') +
                  (document.getElementById('pin2').value || '') +
                  (document.getElementById('pin3').value || '') +
                  (document.getElementById('pin4').value || '');
      if (!name) return showMessage('Enter your name', 'error');
      if (pin.length !== 4) return showMessage('Please enter a 4‑digit PIN', 'error');

      const profiles = getProfiles();
      if (profiles.some(p => p.name.toLowerCase() === name.toLowerCase())) {
        return showMessage('A profile with this name already exists', 'error');
      }

      try {
        // Hash the PIN before storing
        const { hash, salt } = await hashPin(pin);

        const newProfile = {
          id: Date.now().toString(),
          name,
          pinHash: hash,
          pinSalt: salt,
          // No plaintext 'pin' field - security improvement!
          createdAt: new Date().toISOString(),
          data: {
            calorieGoal: 2200,
            proteinGoal: 160,
            weightHistory: [],
            dietLog: {},
            setsLog: []
          }
        };
        profiles.push(newProfile);
        saveProfiles(profiles);
        localStorage.setItem('fittrack_current_profile', newProfile.id);
        showMessage('Profile created!', 'success');
        setTimeout(() => window.location.href = 'index.html', 800);
      } catch (err) {
        console.error('Profile creation error:', err);
        showMessage('Failed to create profile. Please try again.', 'error');
      }
    }

    function selectProfile(profileId) {
      const profiles = getProfiles();
      selectedProfile = profiles.find(p => p.id === profileId);
      if (!selectedProfile) return;
      hideAllSections();
      document.getElementById('selectedUserName').textContent = selectedProfile.name;
      document.getElementById('pinEntry').classList.remove('hidden');
      document.getElementById('verify1').focus();
    }

    async function verifyPin(e) {
      e.preventDefault();
      const enteredPin = (document.getElementById('verify1').value || '') +
                         (document.getElementById('verify2').value || '') +
                         (document.getElementById('verify3').value || '') +
                         (document.getElementById('verify4').value || '');

      if (!selectedProfile) {
        showMessage('No profile selected', 'error');
        return;
      }

      try {
        // Check if profile has hashed PIN (new format)
        if (selectedProfile.pinHash && selectedProfile.pinSalt) {
          const isValid = await verifyPinHash(enteredPin, selectedProfile.pinHash, selectedProfile.pinSalt);
          if (isValid) {
            localStorage.setItem('fittrack_current_profile', selectedProfile.id);
            showMessage('Success! Logging you in...', 'success');
            setTimeout(() => window.location.href = 'index.html', 500);
          } else {
            showMessage('Incorrect PIN. Please try again.', 'error');
            ['verify1','verify2','verify3','verify4'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('verify1').focus();
          }
        }
        // Fallback for old plaintext PINs (shouldn't happen after migration, but defensive)
        else if (selectedProfile.pin) {
          if (enteredPin === selectedProfile.pin) {
            // Immediately hash it and update
            const { hash, salt } = await hashPin(enteredPin);
            selectedProfile.pinHash = hash;
            selectedProfile.pinSalt = salt;
            delete selectedProfile.pin;

            const profiles = getProfiles();
            const idx = profiles.findIndex(p => p.id === selectedProfile.id);
            if (idx !== -1) {
              profiles[idx] = selectedProfile;
              saveProfiles(profiles);
            }

            localStorage.setItem('fittrack_current_profile', selectedProfile.id);
            showMessage('Success! Logging you in...', 'success');
            setTimeout(() => window.location.href = 'index.html', 500);
          } else {
            showMessage('Incorrect PIN. Please try again.', 'error');
            ['verify1','verify2','verify3','verify4'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('verify1').focus();
          }
        } else {
          showMessage('Profile corrupted. Please reset.', 'error');
        }
      } catch (err) {
        console.error('PIN verification error:', err);
        showMessage('Login failed. Please try again.', 'error');
        ['verify1','verify2','verify3','verify4'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('verify1').focus();
      }
    }

    function forgotPin() {
      if (!selectedProfile) return;
      const ok = confirm(`Reset PIN for ${selectedProfile.name}? This will delete all data for this profile.`);
      if (!ok) return;
      const profiles = getProfiles().filter(p => p.id !== selectedProfile.id);
      saveProfiles(profiles);
      showMessage('Profile deleted. Create a new one.', 'success');
      setTimeout(checkExistingProfiles, 800);
    }

    function setupPinInputs() {
      const pinInputs = document.querySelectorAll('.pin-input');
      pinInputs.forEach((input, index) => {
        input.addEventListener('input', function() {
          if (this.value.length >= 1 && index < pinInputs.length - 1) {
            pinInputs[index + 1].focus();
          }
        });
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Backspace' && this.value === '' && index > 0) {
            pinInputs[index - 1].focus();
          }
        });
      });
    }
  </script>
</body>
</html>
